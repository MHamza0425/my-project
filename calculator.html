<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>All Tools Hub — Neon Futuristic Calculator (Final)</title>
<meta name="description" content="Futuristic calculator with graphing, conversions, stats, complex numbers, history, voice, and responsive UI." />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --card:#111827; --neon1:#6366f1; --neon2:#4f46e5;
    --accent:#10b981; --warn:#f59e0b; --danger:#ef4444; --muted:#94a3b8;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,Arial;background:linear-gradient(135deg,var(--bg),#07122b);color:#e6eef8;-webkit-font-smoothing:antialiased}
  .wrap{max-width:1200px;margin:84px auto;padding:18px;display:grid;grid-template-columns:1fr 420px;gap:20px}
  @media(max-width:1000px){ .wrap{grid-template-columns:1fr; padding:14px; margin-top:90px} }
  header{position:fixed;left:0;right:0;top:0;height:72px;background:linear-gradient(90deg,#071025,#07122b);display:flex;align-items:center;z-index:60;box-shadow:0 6px 24px rgba(0,0,0,.6)}
  .bar{max-width:1200px;margin:0 auto;width:100%;display:flex;justify-content:space-between;align-items:center;padding:12px 18px}
  .brand{display:flex;gap:12px;align-items:center}
  .brand h1{margin:0;color:var(--neon2);font-size:20px;letter-spacing:0.4px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 6px rgba(0,0,0,0.4),0 0 8px var(--neon1)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
  .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 0 28px rgba(79,70,229,.08)}
  /* calculator left panel */
  .display{background:var(--glass);padding:14px;border-radius:10px;font-size:28px;text-align:right;min-height:64px;box-shadow:inset 0 0 10px var(--neon1);color:#fff;overflow-wrap:break-word}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:var(--muted);font-weight:600}
  .live-preview{color:var(--muted);font-size:13px}
  .memory{color:#facc15;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  @media(max-width:720px){ .grid{grid-template-columns:repeat(4,1fr);} }
  .key{padding:14px;border-radius:10px;border:none;background:var(--glass);color:#fff;font-weight:800;cursor:pointer;box-shadow:0 6px rgba(0,0,0,.4)}
  .key:hover{transform:translateY(-3px);background:linear-gradient(90deg,var(--neon2),var(--neon1));box-shadow:0 10px rgba(0,0,0,.6)}
  .operator{background:linear-gradient(90deg,#fbbf24,#f59e0b);color:#111}
  .equal{background:linear-gradient(90deg,#34d399,#10b981);grid-column:span 2;color:#022;box-shadow:0 8px rgba(2,78,70,.18)}
  .clear{background:linear-gradient(90deg,#fb7185,#ef4444);color:#111}
  .small{font-size:12px;color:var(--muted)}
  /* right panel */
  .panel-card{background:linear-gradient(180deg,#071022,#0b1226);border-radius:12px;padding:14px;box-shadow:0 0 20px rgba(79,70,229,.06);min-height:120px;color:#dbeafe}
  .panel-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}
  .panel-grid button{padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer;color:#e6eef8;font-weight:700}
  canvas{width:100%;height:260px;border-radius:8px;background:#000;box-shadow:0 0 12px rgba(79,70,229,.12);display:block}
  .neon-input{background:#0f172a;border:2px solid var(--neon1);padding:8px;border-radius:8px;color:#fff;font-weight:700}
  footer{max-width:1200px;margin:20px auto 40px;color:var(--muted);text-align:center;font-size:13px}
  a.email{color:var(--neon2);text-decoration:none;font-weight:700}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <svg width="34" height="34" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="6" fill="#4f46e5"/><path d="M7 12h10" stroke="#fff" stroke-width="1.4" stroke-linecap="round"/></svg>
      <h1>All Tools Hub</h1>
      <div class="small" style="margin-left:6px;color:#9ca3af">Neon Calculator</div>
    </div>
    <div class="controls">
      <button id="radBtn" class="btn ghost">RAD</button>
      <button id="sciBtn" class="btn ghost">SCI OFF</button>
      <button id="voiceBtn" class="btn ghost">🎤 Voice</button>
      <button id="downloadCSV" class="btn">Download CSV</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- LEFT: Calculator -->
  <section class="card">
    <div class="meta">
      <div class="memory" id="memoryDisplay">M: 0</div>
      <div class="small">Live Preview: <span id="livePreview">—</span></div>
    </div>

    <div id="display" class="display" contenteditable="true" spellcheck="false" aria-label="Calculator display">0</div>

    <div style="margin:10px 0" class="small">Tip: Use keyboard or tap buttons. Press Enter to evaluate.</div>

    <div class="grid" id="buttonGrid">
      <button class="key clear" onclick="clearAll()">C</button>
      <button class="key" onclick="backspace()">⌫</button>
      <button class="key" onclick="appendOperator('(')">(</button>
      <button class="key" onclick="appendOperator(')')">)</button>
      <button class="key operator" onclick="appendOperator('/')">÷</button>

      <button class="key" onclick="appendNumber('7')">7</button>
      <button class="key" onclick="appendNumber('8')">8</button>
      <button class="key" onclick="appendNumber('9')">9</button>
      <button class="key operator" onclick="appendOperator('*')">×</button>
      <button class="key" onclick="memoryRecall()">MR</button>

      <button class="key" onclick="appendNumber('4')">4</button>
      <button class="key" onclick="appendNumber('5')">5</button>
      <button class="key" onclick="appendNumber('6')">6</button>
      <button class="key operator" onclick="appendOperator('-')">−</button>
      <button class="key" onclick="memoryAdd()">M+</button>

      <button class="key" onclick="appendNumber('1')">1</button>
      <button class="key" onclick="appendNumber('2')">2</button>
      <button class="key" onclick="appendNumber('3')">3</button>
      <button class="key operator" onclick="appendOperator('+')">+</button>
      <button class="key" onclick="memorySubtract()">M-</button>

      <button class="key" onclick="appendNumber('0')">0</button>
      <button class="key" onclick="appendNumber('.')">.</button>
      <button class="key equal" onclick="calculateResult()">=</button>
      <button class="key" onclick="appendOperator('%')">%</button>
      <button class="key" onclick="appendConstant('PI')">π</button>

      <button class="key" onclick="appendFunction('sin')">sin</button>
      <button class="key" onclick="appendFunction('asin')">asin</button>
      <button class="key" onclick="appendFunction('cos')">cos</button>
      <button class="key" onclick="appendFunction('acos')">acos</button>
      <button class="key" onclick="appendFunction('tan')">tan</button>

      <button class="key" onclick="appendFunction('atan')">atan</button>
      <button class="key" onclick="appendFunction('sinh')">sinh</button>
      <button class="key" onclick="appendFunction('cosh')">cosh</button>
      <button class="key" onclick="appendFunction('tanh')">tanh</button>
      <button class="key" onclick="appendFunction('log10')">log</button>

      <button class="key" onclick="appendFunction('ln')">ln</button>
      <button class="key" onclick="appendFunction('sqrt')">√</button>
      <button class="key" onclick="appendOperator('**2')">x²</button>
      <button class="key" onclick="appendOperator('**3')">x³</button>
      <button class="key" onclick="appendOperator('**')">x^y</button>

      <button class="key" onclick="appendConstant('E')">e</button>
      <button class="key" onclick="factorial()">x!</button>
      <button class="key" onclick="appendOperator('**-1')">1/x</button>
      <button class="key" onclick="toggleAdvanced()">Advanced</button>
      <button class="key" onclick="toggleSci()">Sci</button>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" onclick="downloadCSV()">Export History</button>
      <button class="btn" onclick="clearHistory()">Clear History</button>
      <button class="btn" onclick="loadHistory()">Reload History</button>
    </div>
  </section>

  <!-- RIGHT: Advanced + Tools -->
  <aside class="panel-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 style="margin:0;color:var(--neon1)">Advanced Tools</h3>
      <div class="small" id="modeLabel">Mode: <strong id="raddeg">RAD</strong></div>
    </div>

    <div class="panel-grid" style="margin-bottom:10px">
      <button onclick="showTab('graph')">Graph</button>
      <button onclick="showTab('convert')">Convert</button>
      <button onclick="showTab('stats')">Stats</button>
      <button onclick="showTab('complex')">Complex</button>
      <button onclick="showTab('matrix')">Matrix</button>
      <button onclick="showTab('history')">History</button>
    </div>

    <!-- tab area -->
    <div id="tabArea">
      <!-- Graph -->
      <div id="tab-graph" style="display:none">
        <label class="small">f(x): <input id="functionInput" class="neon-input" placeholder="e.g. sin(x) or x**2+3*x" style="width:100%"></label>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="plotFunction()">Plot</button>
          <button class="btn" onclick="clearPlot()">Clear</button>
        </div>
        <canvas id="graphCanvas" style="margin-top:10px"></canvas>
      </div>

      <!-- Convert -->
      <div id="tab-convert" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="numberInput" class="neon-input" placeholder="Decimal integer" style="flex:1">
          <button class="btn" onclick="convertNumber()">Convert</button>
        </div>
        <div id="numberResult" class="small"></div>

        <hr style="margin:10px 0;border-color:rgba(255,255,255,0.04)">

        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
          <div>
            <label class="small">Length (m)</label>
            <input id="lengthInput" class="neon-input" placeholder="meters">
          </div>
          <button class="btn" onclick="convertUnit('length')">Convert</button>

          <div>
            <label class="small">Weight (kg)</label>
            <input id="weightInput" class="neon-input" placeholder="kg">
          </div>
          <button class="btn" onclick="convertUnit('weight')">Convert</button>

          <div>
            <label class="small">Temp (°C)</label>
            <input id="tempInput" class="neon-input" placeholder="°C">
          </div>
          <button class="btn" onclick="convertUnit('temp')">Convert</button>
        </div>
      </div>

      <!-- Stats -->
      <div id="tab-stats" style="display:none">
        <label class="small">Numbers (comma or space):</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="statsInput" class="neon-input" placeholder="e.g. 2,5,7,10" style="flex:1">
          <button class="btn" onclick="computeStats()">Compute</button>
        </div>
        <div id="statsResult" style="margin-top:8px" class="small"></div>
      </div>

      <!-- Complex -->
      <div id="tab-complex" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="c1" class="neon-input" placeholder="a+bi" style="flex:1">
          <select id="cOp" class="neon-input" style="width:90px">
            <option value="add">+</option>
            <option value="sub">−</option>
            <option value="mul">×</option>
            <option value="div">÷</option>
          </select>
          <input id="c2" class="neon-input" placeholder="c+di" style="flex:1">
        </div>
        <button class="btn" onclick="computeComplex()">Compute</button>
        <div id="complexResult" style="margin-top:8px" class="small"></div>
      </div>

      <!-- Matrix -->
      <div id="tab-matrix" style="display:none">
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
          <input id="m2a11" class="neon-input" placeholder="a11" style="width:68px">
          <input id="m2a12" class="neon-input" placeholder="a12" style="width:68px">
          <input id="m2a21" class="neon-input" placeholder="a21" style="width:68px">
          <input id="m2a22" class="neon-input" placeholder="a22" style="width:68px">
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="matrix2Determinant()">Determinant</button>
          <button class="btn" onclick="matrix2Inverse()">Inverse</button>
        </div>
        <div id="matrix2Result" style="margin-top:8px" class="small"></div>
      </div>

      <!-- History -->
      <div id="tab-history" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn" onclick="downloadCSV()">Download CSV</button>
          <button class="btn" onclick="clearHistory()">Clear</button>
        </div>
        <div id="historyPanel" style="max-height:220px;overflow:auto;border-radius:8px;padding:8px;background:rgba(255,255,255,0.02)"></div>
      </div>
    </div>
  </aside>
</main>

<footer>
  © 2025 All Tools Hub — Neon Calculator • Contact: <a class="email" href="mailto:saadkhan0425@gmail.com">saadkhan0425@gmail.com</a>
</footer>

<script>
/* ---------------------------
   State
----------------------------*/
let calcMemory = 0;
let calcHistory = [];
let radMode = true;      // RAD default
let sciMode = false;
let recognition = null;

/* Elements */
const displayEl = document.getElementById('display');
const livePreviewEl = document.getElementById('livePreview');
const memoryDisplay = document.getElementById('memoryDisplay');
const radBtn = document.getElementById('radBtn');
const sciBtn = document.getElementById('sciBtn');
const voiceBtn = document.getElementById('voiceBtn');
const graphCanvas = document.getElementById('graphCanvas');

/* initialize */
window.addEventListener('DOMContentLoaded', () => {
  loadHistory();
  showTab('history'); // show history by default in panel (user can change)
  drawAxes();
  bindDisplayEvents();
  updateRadDegLabel();
});

/* ---------------------------
   Display helpers + live preview
----------------------------*/
function bindDisplayEvents(){
  displayEl.addEventListener('input', onDisplayInput);
  displayEl.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){ e.preventDefault(); calculateResult(); }
  });
  // prevent pasting of html
  displayEl.addEventListener('paste', e => {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text');
    document.execCommand('insertText', false, text);
  });
}
function setDisplay(text){ displayEl.innerText = String(text); livePreview(); }
function getDisplay(){ return displayEl.innerText.trim(); }
function onDisplayInput(){ livePreview(); }

/* live preview uses safe evaluation but non-destructive */
const SAFE_RE = /^[0-9+\-*/().,%\sA-Za-z_iPIEpie^]*$/;
function livePreview(){
  const expr = getDisplay();
  if(!expr){ livePreviewEl.innerText = '—'; return; }
  let safe = expr.replace(/\^/g,'**').replace(/×/g,'*').replace(/÷/g,'/');
  if(!SAFE_RE.test(safe)){ livePreviewEl.innerText = 'Invalid chars'; return; }
  try{ const val = evaluateExpression(safe); livePreviewEl.innerText = (sciMode && isFinite(val)) ? Number(val).toExponential(6) : String(val); }catch(e){ livePreviewEl.innerText = '—'; }
}

/* ---------------------------
   Append / buttons
----------------------------*/
function appendNumber(n){ const cur = getDisplay(); setDisplay(cur==='0' || cur==='Error' ? String(n) : cur + String(n)); }
function appendOperator(op){ let cur = getDisplay(); if(cur==='Error') cur=''; setDisplay(cur + op); }
function appendFunction(fn){ let cur = getDisplay(); setDisplay(cur + fn + '('); }
function appendConstant(c){ let cur = getDisplay(); setDisplay(cur + (c==='PI'?'PI':(c==='E'?'E':c))); }
function clearAll(){ setDisplay('0'); livePreviewEl.innerText='—'; }
function backspace(){ const cur = getDisplay(); setDisplay(cur.slice(0,-1) || '0'); }

/* Memory */
function memoryAdd(){ calcMemory += parseFloat(getDisplay()) || 0; memoryDisplay.innerText = 'M: '+calcMemory; }
function memorySubtract(){ calcMemory -= parseFloat(getDisplay()) || 0; memoryDisplay.innerText = 'M: '+calcMemory; }
function memoryRecall(){ setDisplay(String(calcMemory)); }

/* ---------------------------
   Safe evaluator
   - wrapper functions added to body string
----------------------------*/
function evaluateExpression(raw){
  if(!raw || !raw.trim()) return 0;
  let expr = String(raw);
  expr = expr.replace(/\^/g,'**').replace(/×/g,'*').replace(/÷/g,'/');
  expr = expr.replace(/(\d+(\.\d+)?)%/g, '($1/100)');
  expr = expr.trim();
  if(/constructor|window|document|=>|function|new\s+/.test(expr)) throw new Error('Unsafe');
  if(!SAFE_RE.test(expr)) throw new Error('Invalid chars');

  // map constants and functions
  expr = expr.replace(/\bPI\b/gi, 'Math.PI');
  expr = expr.replace(/\bE\b/g, 'Math.E');
  expr = expr.replace(/\bsqrt\s*\(/gi, 'Math.sqrt(');
  expr = expr.replace(/\blog10\s*\(/gi, 'Math.log10(');
  expr = expr.replace(/\bln\s*\(/gi, 'Math.log(');
  expr = expr.replace(/\bsinh\s*\(/gi, 'Math.sinh(');
  expr = expr.replace(/\bcosh\s*\(/gi, 'Math.cosh(');
  expr = expr.replace(/\btanh\s*\(/gi, 'Math.tanh(');

  // trig wrappers so RAD/DEG honored
  expr = expr.replace(/\bsin\s*\(/gi, "__TRIG__('sin',");
  expr = expr.replace(/\bcos\s*\(/gi, "__TRIG__('cos',");
  expr = expr.replace(/\btan\s*\(/gi, "__TRIG__('tan',");
  expr = expr.replace(/\basin\s*\(/gi, "__ARCT__('asin',");
  expr = expr.replace(/\bacos\s*\(/gi, "__ARCT__('acos',");
  expr = expr.replace(/\batan\s*\(/gi, "__ARCT__('atan',");

  const body = `
    const radMode = ${radMode};
    function __TRIG__(name,x){
      const v = Number(x);
      if(isNaN(v)) throw 'NaN';
      const a = radMode ? v : v * Math.PI/180;
      if(name==='sin') return Math.sin(a);
      if(name==='cos') return Math.cos(a);
      if(name==='tan') return Math.tan(a);
      return NaN;
    }
    function __ARCT__(name,x){
      const v = Number(x);
      if(isNaN(v)) throw 'NaN';
      if(name==='asin') return radMode ? Math.asin(v) : Math.asin(v) * 180/Math.PI;
      if(name==='acos') return radMode ? Math.acos(v) : Math.acos(v) * 180/Math.PI;
      if(name==='atan') return radMode ? Math.atan(v) : Math.atan(v) * 180/Math.PI;
      return NaN;
    }
    return (${expr});
  `;
  const res = Function(body)();
  if(typeof res === 'number' && !isFinite(res)) throw new Error('Non-finite');
  return res;
}

/* calculate & history */
function calculateResult(){
  const expr = getDisplay();
  try{
    const result = evaluateExpression(expr);
    const out = (sciMode && isFinite(result)) ? Number(result).toExponential(10) : String(result);
    setDisplay(out);
    pushHistory(expr, out);
  }catch(e){
    setDisplay('Error');
  }
}

/* factorial */
function factorial(){
  const n = parseInt(getDisplay());
  if(!Number.isInteger(n) || n < 0 || n > 170){ setDisplay('Error'); return; }
  let f = 1;
  for(let i=2;i<=n;i++) f*=i;
  setDisplay(String(f)); pushHistory(n+'!', f);
}

/* ---------------------------
   History (localStorage)
----------------------------*/
function pushHistory(expression, result){
  const entry = { time: new Date().toISOString(), expression, result };
  calcHistory.push(entry);
  try{ localStorage.setItem('calcHistory', JSON.stringify(calcHistory)); }catch(e){}
  renderHistory();
}
function renderHistory(){
  const panel = document.getElementById('historyPanel');
  if(!panel) return;
  panel.innerHTML = '';
  if(calcHistory.length===0){ panel.innerText = 'No history yet'; return; }
  calcHistory.slice().reverse().forEach(h=>{
    const d = document.createElement('div');
    d.style.padding='6px';
    d.style.borderBottom='1px dashed rgba(255,255,255,0.03)';
    d.style.cursor='pointer';
    d.innerHTML = `<div style="font-size:12px;color:${'var(--muted)'}">${new Date(h.time).toLocaleString()}</div>
                   <div style="font-weight:700">${h.expression} = <span style="color:#a7f3d0">${h.result}</span></div>`;
    d.onclick = ()=> setDisplay(h.result);
    panel.appendChild(d);
  });
}
function loadHistory(){
  try{ const saved = JSON.parse(localStorage.getItem('calcHistory')||'[]'); calcHistory = Array.isArray(saved)? saved: []; }catch(e){ calcHistory=[]; }
  renderHistory();
}
function clearHistory(){
  if(!confirm('Clear history?')) return;
  calcHistory=[]; localStorage.removeItem('calcHistory'); renderHistory();
}
function downloadCSV(){
  if(calcHistory.length===0){ alert('No history'); return; }
  const rows = ['Time,Expression,Result'];
  calcHistory.forEach(h=> rows.push(`${h.time},"${h.expression.replace(/"/g,'""')}","${String(h.result).replace(/"/g,'""')}"`));
  const blob = new Blob([rows.join('\n')], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='calc_history.csv'; a.click();
}

/* ---------------------------
   UI toggles
----------------------------*/
function toggleRadDeg(){ radMode = !radMode; updateRadDegLabel(); livePreview(); }
function updateRadDegLabel(){ document.getElementById('raddeg').innerText = radMode ? 'RAD' : 'DEG'; radBtn.innerText = radMode ? 'RAD' : 'DEG'; }
radBtn.onclick = toggleRadDeg;

function toggleSci(){ sciMode = !sciMode; sciBtn.innerText = sciMode ? 'SCI ON' : 'SCI OFF'; livePreview(); }
sciBtn.onclick = toggleSci;

function toggleAdvanced(){ // toggles advanced panel view; here, just show graph tab
  const adv = document.getElementById('tab-graph');
  if(adv.style.display==='none') showTab('graph'); else showTab('history');
}

/* ---------------------------
   Tabs / panel
----------------------------*/
function showTab(name){
  const ids = ['graph','convert','stats','complex','matrix','history'];
  ids.forEach(id => {
    const el = document.getElementById('tab-'+id);
    if(el) el.style.display = (id===name)?'block':'none';
  });
}

/* ---------------------------
   Graph plotting (canvas)
----------------------------*/
function drawAxes(){
  const c = graphCanvas;
  if(!c) return;
  c.width = c.clientWidth;
  c.height = 260;
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle = '#000'; ctx.fillRect(0,0,c.width,c.height);
  ctx.strokeStyle = 'rgba(148,163,184,0.08)';
  for(let x=0;x<=c.width;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,c.height); ctx.stroke(); }
  for(let y=0;y<=c.height;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(c.width,y); ctx.stroke(); }
  ctx.strokeStyle = '#64748b'; ctx.lineWidth=1.2;
  ctx.beginPath(); ctx.moveTo(0,c.height/2); ctx.lineTo(c.width,c.height/2); ctx.moveTo(c.width/2,0); ctx.lineTo(c.width/2,c.height); ctx.stroke();
}
function plotFunction(){
  const fn = document.getElementById('functionInput').value.trim();
  if(!fn){ alert('Enter a function like sin(x) or x**2'); return; }
  drawAxes();
  const c = graphCanvas;
  if(!c) return;
  const ctx = c.getContext('2d'); ctx.lineWidth = 2; ctx.strokeStyle = '#10b981'; ctx.beginPath();
  const W = c.width, H = c.height, xScale = 40, yScale = 40;
  let first=true;
  for(let px=0; px<=W; px++){
    const x = (px - W/2)/xScale;
    let expr = fn.replace(/x/g, `(${x})`).replace(/\^/g,'**').replace(/×/g,'*').replace(/÷/g,'/');
    try{
      if(!SAFE_RE.test(expr)) { first=true; continue; }
      const y = evaluateExpression(expr);
      if(!isFinite(y)){ first=true; continue; }
      const py = H/2 - y*yScale;
      if(first){ ctx.moveTo(px,py); first=false; } else ctx.lineTo(px,py);
    }catch(e){ first=true; continue; }
  }
  ctx.stroke();
}
function clearPlot(){ drawAxes(); }

/* ---------------------------
   Number conversion, stats, complex, matrix, units
----------------------------*/
function convertNumber(){
  const v = document.getElementById('numberInput').value.trim();
  const n = parseInt(v,10);
  const out = document.getElementById('numberResult');
  if(isNaN(n)){ out.innerText = 'Enter a valid decimal integer'; return; }
  out.innerHTML = `<div class="small">Bin: ${n.toString(2)} | Oct: ${n.toString(8)} | Hex: ${n.toString(16).toUpperCase()}</div>`;
}
function computeStats(){
  const txt = document.getElementById('statsInput').value;
  const arr = txt.split(/[, \t]+/).map(Number).filter(x=>!isNaN(x));
  const out = document.getElementById('statsResult');
  if(arr.length===0){ out.innerText='Provide numbers'; return; }
  const n = arr.length;
  const mean = arr.reduce((a,b)=>a+b,0)/n;
  const sorted=[...arr].sort((a,b)=>a-b);
  const median = n%2 ? sorted[(n-1)/2] : (sorted[n/2-1]+sorted[n/2])/2;
  const variance = arr.reduce((a,b)=>a+(b-mean)**2,0)/n;
  const std = Math.sqrt(variance);
  out.innerHTML = `<div class="small">Count: ${n} • Mean: ${mean.toFixed(6)} • Median: ${median} • Std: ${std.toFixed(6)}</div>`;
}
function parseComplex(s){
  if(!s) return null;
  s = s.replace(/\s+/g,'').toLowerCase();
  const pureReal = /^([+-]?\d*\.?\d+)$/.exec(s);
  if(pureReal) return {re:parseFloat(pureReal[1]), im:0};
  const pureImag = /^([+-]?\d*\.?\d+)i$/.exec(s);
  if(pureImag) return {re:0, im:parseFloat(pureImag[1])};
  const both = /^([+-]?\d*\.?\d+)([+-]\d*\.?\d+)i$/.exec(s);
  if(both) return {re:parseFloat(both[1]), im:parseFloat(both[2])};
  return null;
}
function computeComplex(){
  const a = parseComplex(document.getElementById('c1').value);
  const b = parseComplex(document.getElementById('c2').value);
  const op = document.getElementById('cOp').value;
  const out = document.getElementById('complexResult');
  if(!a || !b){ out.innerText='Invalid complex input'; return; }
  let r;
  if(op==='add') r = {re:a.re+b.re, im:a.im+b.im};
  if(op==='sub') r = {re:a.re-b.re, im:a.im-b.im};
  if(op==='mul') r = {re:a.re*b.re - a.im*b.im, im:a.re*b.im + a.im*b.re};
  if(op==='div'){
    const den = b.re*b.re + b.im*b.im; if(den===0){ out.innerText='Division by zero'; return; }
    r = {re:(a.re*b.re + a.im*b.im)/den, im:(a.im*b.re - a.re*b.im)/den};
  }
  out.innerText = `${r.re.toFixed(6)} ${r.im>=0?'+':'-'} ${Math.abs(r.im).toFixed(6)}i`;
}
function matrix2Determinant(){
  const a = parseFloat(document.getElementById('m2a11').value)||0;
  const b = parseFloat(document.getElementById('m2a12').value)||0;
  const c = parseFloat(document.getElementById('m2a21').value)||0;
  const d = parseFloat(document.getElementById('m2a22').value)||0;
  document.getElementById('matrix2Result').innerText = `Determinant = ${ (a*d - b*c) }`;
}
function matrix2Inverse(){
  const a = parseFloat(document.getElementById('m2a11').value)||0;
  const b = parseFloat(document.getElementById('m2a12').value)||0;
  const c = parseFloat(document.getElementById('m2a21').value)||0;
  const d = parseFloat(document.getElementById('m2a22').value)||0;
  const det = a*d - b*c;
  if(det===0){ document.getElementById('matrix2Result').innerText = 'No inverse (det=0)'; return; }
  document.getElementById('matrix2Result').innerText = `Inverse: [[${(d/det).toFixed(6)}, ${(-b/det).toFixed(6)}],[${(-c/det).toFixed(6)}, ${(a/det).toFixed(6)}]]`;
}
function convertUnit(type){
  if(type==='length'){ const input = parseFloat(document.getElementById('lengthInput').value)||0; alert(`${input} m = ${input*100} cm`); }
  else if(type==='weight'){ const input = parseFloat(document.getElementById('weightInput').value)||0; alert(`${input} kg = ${input*1000} g`); }
  else if(type==='temp'){ const input = parseFloat(document.getElementById('tempInput').value)||0; alert(`${input} °C = ${(input*9/5+32).toFixed(2)} °F`); }
}

/* ---------------------------
   Voice Input (Web Speech)
----------------------------*/
voiceBtn.onclick = toggleVoice;
function toggleVoice(){
  if(!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)){ alert('Speech Recognition not supported'); return; }
  if(recognition){ recognition.stop(); recognition=null; voiceBtn.innerText='🎤 Voice'; return; }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR(); recognition.lang='en-US'; recognition.interimResults=false; recognition.maxAlternatives=1;
  voiceBtn.innerText = '⏺ Listening...';
  recognition.onresult = e => {
    const t = e.results[0][0].transcript.toLowerCase();
    const expr = speechToExpression(t);
    if(expr) { setDisplay(expr); livePreview(); } else alert('Could not parse: '+t);
  };
  recognition.onerror = ()=>{ recognition=null; voiceBtn.innerText='🎤 Voice'; };
  recognition.onend = ()=>{ recognition=null; voiceBtn.innerText='🎤 Voice'; };
  recognition.start();
}
function speechToExpression(s){
  let t = ' '+s+' ';
  const map = {' plus ':' + ',' minus ':' - ',' times ':' * ',' divided by ':' / ',' over ':' / ',' power ':' ** ',' to the power of ':' ** ',' open bracket ':' ( ',' close bracket ':' ) ',' pi ':' PI ',' e ':' E '};
  Object.keys(map).forEach(k=> t = t.replaceAll(k,map[k]));
  t = t.replace(/\bzero\b/g,'0').replace(/\bone\b/g,'1').replace(/\btwo\b/g,'2').replace(/\bthree\b/g,'3').replace(/\bfour\b/g,'4').replace(/\bfive\b/g,'5').replace(/\bsix\b/g,'6').replace(/\bseven\b/g,'7').replace(/\beight\b/g,'8').replace(/\bnine\b/g,'9');
  t = t.replace(/[^0-9+\-*/().%PIEpie\*\s]/g,'');
  return t.trim();
}

/* ---------------------------
   Utility: show tab & initial states
----------------------------*/
showTab('history'); drawAxes();

/* expose some functions for inline attributes */
window.appendNumber = appendNumber;
window.appendOperator = appendOperator;
window.appendFunction = appendFunction;
window.appendConstant = appendConstant;
window.clearAll = clearAll;
window.backspace = backspace;
window.calculateResult = calculateResult;
window.factorial = factorial;
window.memoryAdd = memoryAdd;
window.memorySubtract = memorySubtract;
window.memoryRecall = memoryRecall;
window.toggleAdvanced = toggleAdvanced;
window.plotFunction = plotFunction;
window.clearPlot = clearPlot;
window.convertNumber = convertNumber;
window.computeStats = computeStats;
window.computeComplex = computeComplex;
window.matrix2Determinant = matrix2Determinant;
window.matrix2Inverse = matrix2Inverse;
window.convertUnit = convertUnit;
window.toggleRadDeg = toggleRadDeg;
window.toggleSci = toggleSci;
window.toggleVoice = toggleVoice;
window.downloadCSV = downloadCSV;
window.loadHistory = loadHistory;
window.clearHistory = clearHistory;
window.showTab = showTab;
</script>
</body>
</html>
